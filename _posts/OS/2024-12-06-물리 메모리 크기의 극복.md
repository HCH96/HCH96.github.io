---
title: Swap 공간을 활용한 메모리 관리와 Page Fault
date: 2024-12-06 22:00:00 +09:00
categories: [OS, Virtualization]
tags:
  [operating system, ostep, 페이징]
---

## 기존 메모리 관리의 한계
지금까지 살펴본 메모리 관리 방법은 모두 가상 주소 공간의 크기가 물리 메모리 크기보다 작은 경우를 전제로 했다.하지만 가상 주소 공간 크기가 메모리보다 클 경우 추가적인 메모리 관리 방법이 필요하다.

### **메모리 계층 구조와 Disk의 역할**
- Memory Hierarchy(메모리 계층 구조):
    - 모든 페이지가 메모리에 존재한다고 가정했던 기존 Paging 기법은 물리 메모리보다 큰 주소 공간을 가진 프로세스를 처리하기 어렵다.
    - 이를 해결하기 위해, 운영체제는 사용 빈도가 낮은 페이지를 메모리에서 해제하고 Disk로 이동시킨다.

**메모리 계층 구조**

- Registers (레지스터): 가장 빠르고 용량이 작으며, 비용이 높음.
- Cache (캐시): 빠르고 용량이 제한적임.
- Main Memory (DRAM): 중간 속도, 중간 비용.
- Disk (HDD/SSD): 느리지만 용량이 크고 비용이 저렴.

- 특징:
    - 위로 갈수록 빠르고 용량이 적으며 비용이 비싸다.
    - 아래로 갈수록 느리고 용량이 크며 비용이 저렴하다.

### **프로세스에게 큰 주소 공간을 제공하는 이유**

- 사용 편의성:
    - 운영체제가 큰 주소 공간을 제공하면, 프로그래머는 프로세스를 위한 메모리가 충분한지 걱정할 필요가 없음.
    - 프로그램 실행 시 운영체제에 메모리 할당 요청만 하면 됨.

- 멀티프로세스와 메모리 가상화:
    - 멀티프로세서 환경에서는 동시에 여러 프로세스가 실행되므로 모든 페이지를 물리 메모리에 저장할 수 없음.
    - Disk를 활용해 더 큰 가상 메모리 공간을 제공하여 효율적으로 처리 가능.

---

## **스왑공간**

### 스왑 공간의 정의와 역할
스왑 공간(Swap Space)은 디스크에서 메모리 페이지를 저장하기 위한 공간이다. 이 공간은 페이지를 디스크에 저장(Swap Out)하거나, 디스크에서 읽어 메모리에 탑재(Swap In)하는 데 사용된다. 스왑 공간에서의 입출력 단위는 페이지라고 가정한다.

운영체제는 스왑 공간에 저장된 모든 페이지의 디스크 주소를 관리해야 한다. 또한, 스왑 공간의 크기는 시스템에서 사용할 수 있는 메모리 페이지의 최대 수를 결정한다. 스왑 공간이 충분히 크다면, 실제 물리 메모리 크기를 초과하는 가상 메모리 공간을 운영체제가 제공할 수 있다.

### 스왑 공간 활용의 기본 개념
스왑 공간을 통해 운영체제는 실제 물리 메모리보다 더 큰 메모리 공간을 사용하는 것처럼 가장할 수 있다. 예를 들어, 물리 메모리가 4개의 페이지를 저장할 수 있고, 스왑 공간이 8개의 페이지를 저장할 수 있는 경우를 가정해 보자. 이때, 세 개의 프로세스(Proc 0, Proc 1, Proc 2)가 물리 메모리를 공유하며 일부 페이지는 물리 메모리에, 나머지는 스왑 공간에 저장된다.

![alt text](/assets/img/OS/페이지폴트/image.png)
_물리 메모리와 스왑 공간_

이런 방식으로 물리 메모리의 용량 제한을 극복할 수 있으며, 실행되지 않는 페이지는 스왑 공간으로 이동시켜 메모리 공간을 확보할 수 있다.

### 프로그램 실행과 메모리 관리
프로그램 실행 시, 실행 파일의 페이지들은 디스크에 저장되어 있다. 프로그램이 실행되면, 해당 페이지들은 필요할 때 메모리에 로드된다. 이 로드는 한 번에 모든 페이지를 메모리에 탑재하거나, 필요 시 한 페이지씩 이루어진다.

특히, 코드 영역의 페이지는 디스크에 원본이 저장되어 있으므로, 물리 메모리에서 제거되더라도 언제든지 다시 로드(Swap-In)할 수 있다. 이렇게 하면 코드 페이지가 차지하고 있던 물리 메모리 공간을 다른 페이지가 사용할 수 있다.


---

## **페이지 스왑과 TLB 동작**

### **메모리 참조 과정**
페이지 스왑을 이해하기 위해 먼저 메모리 참조 과정에 대해 정리해보자. 하드웨어 기반의 **TLB(Translation Lookaside Buffer)**를 사용하는 시스템을 가정한다.

1. **가상 메모리 참조 생성**:
   - 프로세스가 명령어 실행 또는 데이터 접근 시 가상 메모리 주소를 생성한다.
   - 하드웨어는 가상 주소를 물리 주소로 변환해야 한다.

2. **TLB 검사**:
   - 하드웨어는 가상 주소에서 **VPN(Virtual Page Number)**를 추출한 후, 해당 정보가 TLB에 있는지 확인한다.
   - **TLB 히트**:
     - TLB에서 해당 정보를 찾으면 물리 주소를 얻고, 메모리에서 데이터를 가져온다.
     - 매우 빠른 방식이며, 대부분의 경우 여기에 해당하기를 바란다.
   - **TLB 미스**:
     - TLB에 정보가 없다면, 하드웨어는 페이지 테이블을 참조하여 정보를 찾아야 한다.

3. **페이지 테이블 참조**:
   - 하드웨어는 **페이지 테이블 베이스 레지스터**를 통해 페이지 테이블의 메모리 주소를 파악한다.
   - VPN을 인덱스로 사용하여 페이지 테이블 항목(PTE)을 추출한다.
   - 페이지 테이블 항목이 유효하고, 페이지가 물리 메모리에 존재하면 다음을 수행한다:
     - PTE에서 PFN(Physical Frame Number)을 가져온다.
     - TLB에 PFN 정보를 탑재한 후, 명령어를 재실행한다.
     - 이 과정 이후에는 TLB 히트가 발생하여 더 빠르게 접근할 수 있다.

### **Present Bit**
- **Present 비트**는 각 페이지 테이블 항목(PTE)에 페이지의 상태를 나타낸다.
  - **1**: 페이지가 물리 메모리에 존재함.
  - **0**: 페이지가 물리 메모리에 존재하지 않고 디스크에 저장되어 있음.
- 페이지가 물리 메모리에 존재하지 않는 경우, 이를 접근하려고 하면 **페이지 폴트(Page Fault)**가 발생한다.

---
## **페이지 폴트와 교체 정책**
### **페이지 폴트**란?
  - 물리 메모리에 존재하지 않는 페이지를 접근하려고 할 때 발생하는 이벤트이다.
  - Present 비트가 0으로 설정된 페이지를 참조할 때 발생한다.
  
### **페이지 폴트(Page Fault)**
  1. 운영체제의 **페이지 폴트 핸들러**가 실행된다.
  2. 페이지 테이블에서 해당 페이지의 디스크 위치를 확인.
  3. 디스크에서 해당 페이지를 읽어와 메모리에 탑재.
  4. 페이지 테이블(PTE)을 갱신(PFN 업데이트).
  5. 명령어를 재실행하여 작업을 완료.
![alt text](/assets/img/OS/페이지폴트/image-1.png)
_페이지 폴트 제어 흐름 알고리즘(하드웨어)_

![alt text](/assets/img/OS/페이지폴트/image-2.png)
_페이지 폴트 제어 흐름 알고리즘(소프트웨어)_

- **I/O 중첩**:
  - 페이지 폴트 처리 중 해당 프로세스는 **차단(blocked)** 상태가 된다.
  - 운영체제는 다른 프로세스를 실행하여 CPU 활용도를 높인다.

### **메모리에 여유 공간이 없는 경우**
- **페이지 아웃(Page-Out)**:
  - 새로운 페이지를 탑재하기 위해 메모리가 부족하면 기존 페이지를 내보냄.
  - 어떤 페이지를 내보낼지 결정하는 정책을 **페이지 교체 정책(Page-Replacement Policy)**라고 한다.
  
- **페이지 교체의 중요성**:
  - 잘못된 교체 정책은 프로그램의 성능을 저하시킬 수 있음.
  - 디스크 접근 속도는 메모리보다 훨씬 느리므로, 잘못된 선택은 성능에 큰 영향을 미침.


### **페이지 교체 정책과 스왑 데몬**
- **여유 공간 관리**:
  - 운영체제는 메모리 여유 공간을 확보하기 위해 **최솟값(Low Watermark, LW)**과 **최댓값(High Watermark, HW)**을 설정.
  - 여유 공간이 LW 이하로 떨어지면 **백그라운드 쓰레드**(스왑 데몬 또는 페이지 데몬)가 실행되어 여유 공간을 확보.
  - 여유 공간이 HW에 도달하면 쓰레드는 슬립 상태로 전환.

- **클러스터링 기법**:
  - 다수의 페이지를 한 번에 디스크로 스왑하여 디스크 효율을 높임.
  - 클러스터링은 디스크의 탐색 시간과 회전 지연을 줄이는 효과를 제공.

### **하드웨어와 소프트웨어의 역할**
- **TLB 미스 처리**:
  - 페이지가 존재하면 PTE에서 PFN을 가져와 TLB를 갱신.
  - 페이지가 물리 메모리에 없으면 페이지 폴트 핸들러가 실행.

- **페이지 유효성 검사**:
  - 페이지가 **유효하지만 존재하지 않을 경우**: 페이지 폴트를 처리해 디스크에서 데이터를 가져옴.
  - 페이지가 **유효하지 않을 경우**: 잘못된 접근으로 간주, 운영체제가 예외를 처리.

페이지 폴트와 교체 정책은 운영체제가 물리 메모리와 디스크를 효율적으로 활용하기 위해 사용하는 핵심 기술이다. 여유 공간 관리와 교체 정책의 최적화는 시스템 성능에 큰 영향을 미치며, 멀티프로세스 환경에서 반드시 고려되어야 한다.
